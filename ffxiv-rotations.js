var selectedClassId,selectedClass="Monk",base="0123456789abcdefghijklmnopqrstuvwxyz";function toURLBase(e){for(var l=base.length,t="";0!=e;)t=base[e%l]+t,e=Math.floor(e/l);return t}function fromURLBase(e){e=e.toLowerCase();for(var l=base.length,t=0,s=1,i=e.length-1;0<=i;i--)t+=base.indexOf(e[i])*s,s*=l;return t}var Skill=function(){function e(){}return e.prototype.displayName=function(){return this.name.replace("{class}",selectedClass)},e.prototype.iconPath=function(){return this.multiIcon?"icons/"+this.icon+(selectedClassId-8)+".png":"icons/"+this.icon+".png"},e.prototype.resourceType=function(){switch(this.category){case 2:return"MP";case 3:return"TP";case 4:return"";case 6:return"GP";case 7:return"CP"}},e.prototype.isCombatantSkill=function(){return 2==this.category||3==this.category||4==this.category||null==this.category},e.prototype.isCrossClassSkill=function(){return-1!=db.classes[selectedClass].cross.indexOf(this.id)},e}();function getSkill(e){var l=new Skill,t=db.skills[e];return l.id=e,l.name=t.name,l.help_html=t.help_html,l.level=t.level,l.cast_time=t.cast_time,l.recast_time=t.recast_time,l.cost=t.cost,l.cast_range=t.cast_range,l.icon=t.icon,l.category=t.category,l.radius=t.radius,l.cross_class_skill=t.cross_class_skill,l.gcd=t.gcd,t.deprecated&&(l.deprecated=!0),t.multiIcon&&(l.multiIcon=!0),l}function hasError(e){return"error"in e}function pluralize(e,l){return 1==l?"1 "+e:l.toString()+" "+e+"s"}function createSkillInfoMouseOver(e,t){e.hover(function(){var l=t;l.isCrossClassSkill()&&null!=l.cross_class_skill&&(l=getSkill(l.cross_class_skill)),$("#skillInfo .skillIcon").attr("src",l.iconPath()),$("#skillName").html(l.displayName()),$("#skillDescription").html(l.help_html);var e=[["Level",null!=l.level,function(){return l.level.toString()}],["Cast",null!=l.cast_time&&l.isCombatantSkill(),function(){return 0==l.cast_time?"Instant":pluralize("second",l.cast_time)}],["Recast",null!=l.recast_time&&l.isCombatantSkill(),function(){return pluralize("second",l.recast_time)}],["Cost",null!=l.cost,function(){return"number"==typeof l.cost?l.cost+" "+l.resourceType():l.cost}],["Range",null!=l.cast_range&&l.isCombatantSkill(),function(){var e=l.cast_range;if(-1==e)switch(selectedClass){case"Bard":case"Machinist":e=25;break;default:e=3}return pluralize("yalm",e)}],["Radius",null!=l.radius&&(2==l.category||3==l.category||4==l.category),function(){return pluralize("yalm",l.radius)}]];$("#skillProperties").empty(),$.each(e,function(e,l){l[1]&&$("#skillProperties").append($("<tr>").append($("<td>").text(l[0]),$("<td>").text(l[2]())))}),$("#skillInfo").slideDown()})}function createSkillDiv(e){var l=getSkill(e),t=$('<div class="skillIcon">');return t.css("background-image","url("+l.iconPath()+")"),t.data("id",e),0==l.gcd&&t.append('<i class="material-icons gcd">replay</i>'),createSkillInfoMouseOver(t,l),t}function createSkillSelectorDiv(e,l){var t=e.displayName(),s=e.level,i=$('<div class="skillSelectorItem">'),t=$('<div class="miniInfo truncate">').html(t+"<br/>Lv. "+(s?s.toString():"any")),s=$('<div class="skillIconContainer">');return s.append(createSkillDiv(e.id)),i.append(s),i.append(t),i}function copySkillDiv(e){return createSkillDiv(e.data("id"))}function applyModel(e){if(null!=e&&0<e.length)for(var l=e.split(","),t=0;t<l.length;t++){var s=createSkillDiv(parseInt(l[t]));$("#sortable").append(s)}updateClassSelect(),updateArrows()}function updateClassSelect(){$("#class").val(selectedClass),$("#class").material_select()}function getSkillSequenceString(){var t=[];return $.each($("#sortable .skillIcon"),function(e,l){t.push($(l).data("id"))}),t.join()}function setVisits(e){-1==e?$("#hits").text("0 views of this skill sequence - share the link!"):$("#hits").text(+e+" views of this skill sequence")}function setModified(e){!0===e?$("#share").removeClass("disabled"):$("#share").addClass("disabled")}function modelUpdate(){setModified(!0),updateArrows();var e=getSkillSequenceString();Cookies.set(selectedClass,e)}function getClassIcon(e){return"classIcons/"+e.replace(/\s/g,"").toLowerCase()+"3.png"}function sortSkillsByLevel(e){e.sort(function(e,l){e=getSkill(e),l=getSkill(l);return e.level-l.level})}function populateSkillSection(t,e){null!=e&&e.length?($(t).parent().parent().show(),sortSkillsByLevel(e),$.each(e,function(e,l){l=getSkill(l);l.deprecated||$(t).append(createSkillSelectorDiv(l,!1))})):$(t).parent().parent().hide()}function populateSkillSelector(){populateSkillSection("#classSkills",db.classes[selectedClass].native),populateSkillSection("#iaijutsuSkills",db.classes[selectedClass].iaijutsu),populateSkillSection("#summonSkills",db.classes[selectedClass].summon),populateSkillSection("#specialistSkills",db.classes[selectedClass].specialist),populateSkillSection("#ninjutsuSkills",db.classes[selectedClass].ninjutsu),populateSkillSection("#stepSkills",db.classes[selectedClass].step),populateSkillSection("#crossClassSkills",db.classes[selectedClass].cross),"hand"!=db.classes[selectedClass].discipline&&"land"!=db.classes[selectedClass].discipline?populateSkillSection("#miscSkills",db.misc):populateSkillSection("#miscSkills",[]),$(".skillSelector .skillIcon").draggable({helper:function(e){return copySkillDiv($(e.target))},connectToSortable:"#sortable",distance:5}),$(".skillSelectorItem").on("click",function(e){$("#sortable").append(copySkillDiv($(this).find(".skillIcon"))),modelUpdate()})}function clearSequence(){$("#sortable").empty()}function updateArrows(){$("#sortable .arrow").remove(),$("#sortable .skillIcon:not(.ui-sortable-helper)").each(function(e,l){}).after($('<div class="arrow">'))}$(function(){$(".modal-trigger").leanModal(),$("#skillInfo").pushpin({top:$("#skillInfo").offset().top}),$("#skillInfo").hide(),$("#clear").click(function(){clearSequence(),modelUpdate()}),$("#share").click(function(){$.get("https://ffxivrotations.com/share.py",{class:selectedClass,sequence:getSkillSequenceString()}).done(function(e){hasError(e)||(history.replaceState({},"","/"+toURLBase(e.id)),setModified(!1),Materialize.toast("URL updated!",6e3),setVisits(e.hits))})}),$("#class").change(function(){selectedClass=$("#class").val(),selectedClassId=db.classes[selectedClass].id,clearSequence();var e=Cookies.get(selectedClass);null!=e&&applyModel(e),$(".skillSelector").empty(),populateSkillSelector(),modelUpdate()});var t=!1;$("#sortable").sortable({items:".skillIcon",placeholder:"skillIcon block-placeholder",distance:5,stop:function(e,l){modelUpdate()},tolerance:"pointer",over:function(){t=!1},out:function(){t=!0},beforeStop:function(e,l){1==t&&l.item.remove()},change:function(e,l){updateArrows()}}),$("#sortable").disableSelection(),$("#sortable").on("click","div",function(e){$(e.target).remove(),modelUpdate()});var e=location.pathname.lastIndexOf("/"),l=(fromURLBase(location.pathname.substring(e+1)),$.getJSON("db.json")),e=$.getJSON("dummy.json");$.when(l,e).done(function(e,l){db=e[0];l=l[0];hasError(l)||(selectedClass=l.class,applyModel(l.sequence),setVisits(l.hits)),console.log("got both data"),populateSkillSelector(),$.each(db.classes,function(e,l){l="#"+l.discipline+"Selector";$(l).append($("<option></option>").attr("value",e).attr("data-icon",getClassIcon(e)).attr("class","left").text(e))}),updateClassSelect()})});